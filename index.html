<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link href="./css/elegant-icons-style.css" rel="stylesheet"/>
    <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href="./css/style.css" rel="stylesheet">
    <link href="./css/style-responsive.css" rel="stylesheet"/>
    <link href="./css/corner-ribbon.css" rel="stylesheet"/>
    <link href="https://cdn.datatables.net/1.10.11/css/dataTables.bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.datatables.net/select/1.1.2/css/select.dataTables.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet"/>

    <script src="//code.jquery.com/jquery-1.12.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.11/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.1.2/js/dataTables.select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <!-- gmaps.js -->
    <script src="./js/gmaps.js" type="text/javascript"></script>

    <!-- nice scroll -->
    <script src="./js/jquery.scrollTo.min.js"></script>
    <script src="./js/jquery.nicescroll.js" type="text/javascript"></script>

    <!-- Added for the Toggle Support -->
    <script src="./js/scripts.js"></script>

    <!-- Added for timestamp -->
    <script src="./js/moment.min.js"></script>
    <script src="./js/livestamp.min.js"></script>

    <!-- Added for Highchart -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="./js/highcharts-themes.min.js" type="text/javascript"></script>

    <style>
        #chartPowerConsumption {
            height: 245px;
        }

        .label-danger {
            /*margin-right: 18px;*/
            margin-top: 3px;
        }

        table tr td {
            height: 35px;
        }

        .notification-row .form-control:focus {
            border-color: #49bfff;
            outline: 0;
            -webkit-box-shadow: inset 0 0 0;
            box-shadow: inset 0 0 0;
        }

        .filter-block {
            display: block;
            margin: 10px 0;
            text-align: left;
        }

        .filter-block.margin-bottom {
            margin-bottom: 25px;
        }

        .filter-block > .filter-header {
            margin: 0;
            padding: 0;
            font-weight: 600;
            font-size: 16px;
        }

        .filter-block > .filter-text {
            text-transform: uppercase;
        }

        /* enable absolute positioning */
        .inner-addon {
            position: relative;
        }

        .inner-addon .glyphicon {
            position: absolute;
            padding: 10px;
            pointer-events: none;
        }

        /* align icon */
        .left-addon .glyphicon  { left:  0px;}
        .right-addon .glyphicon { right: 0px;}

        /* add padding  */
        .left-addon input  { padding-left:  30px; }
        .right-addon input { padding-right: 30px; }

        .box .nav-stacked > li {
            border-bottom: 1px solid #f4f4f4;
            margin: 0;
        }

        .box-header > h1 {
            font-size: 2.6em;
            height: 40px;
            width: 100%;
            /*display:inline-block;*/
            white-space: nowrap;
            overflow: hidden !important;
            text-overflow: ellipsis;
        }

        .box .nav-stacked > li:last-of-type {
            border-bottom: none;
        }

        .box-header > .box-tools [data-toggle="tooltip"] {
            position: relative;
        }

        .box-pane-left {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-left-radius: 3px;
        }
    </style>

    <title>Street Lighting</title>
</head>
<body>
<section id="container">
    <!-- Start of Title Bar -->
    <header class="header dark-bg">
        <div class="toggle-nav">
            <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"><i
                    class="icon_menu"></i></div>
        </div>
        <a href="index.html" class="logo"> Street <span class="lite">Lighting</span></a>
        <div class="nav search-row" id="top_menu">
            <!--  search form start -->
            <ul class="nav top-menu">
                <li>
                    <form class="navbar-form">
                        <input type="text" class="form-control" placeholder="Search...">
                    </form>
                </li>
            </ul>
            <!--  search form end -->
        </div>
        <div class="top-nav notification-row top-menu">
            <!-- notification dropdown start-->
            <ul class="nav pull-right top-menu">
                <li class="dropdown">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                            <span class="fa-stack">
                              <i class="fa fa-circle fa-stack-2x"></i>
                              <i class="fa fa-user fa-lg fa-stack-1x fa-inverse"></i>
                            </span>
                        <span class="username">User Admin</span>
                        <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu extended logout">
                        <div class="log-arrow-up"></div>
                        <li class="eborder-top"><a href="/profile"><i class="icon_id-2"></i> My Profile</a></li>
                        <li><a href="/company"><i class="icon_building"></i> Manage Company</a></li>
                        <li><a href="/user"><i class="icon_group"></i> Manage User</a></li>
                        <li><a href="/admin_api"><i class="icon_cogs"></i> Manage API</a></li>
                        <li><a href="/logout"><i class="icon_key_alt"></i> Log Out</a></li>
                    </ul>
                </li>
            </ul>
            <!-- notification dropdown end -->
        </div>
    </header>
    <!-- End of Title Bar -->

    <!-- Start of Side Panel -->
    <aside>
        <div id="sidebar" class="nav-collapse">
            <ul class="sidebar-menu">
                <li class="active"><a class="" href="index.html"><i
                        class="icon_house_alt"></i><span>Dashboard</span></a></li>
                <li><a class="" href="alerts.html"><i class="icon_error-triangle_alt"></i><span>Alerts</span><span
                        id="alert_sidebar" class="label label-danger pull-right">4</span></a></li>
                <li><a class="" href="profiles.html"><i class="icon_lightbulb_alt"></i><span>Profiles</span></a></li>
                <li><a class="" href="reports.html"><i class="icon_datareport_alt"></i><span>Report</span></a></li>
            </ul>
        </div>
    </aside>
    <!-- End of Side Panel -->

    <!-- Start of Main Content -->
    <section id="main-content">
        <section class="wrapper">

            <!-- Breadcrumb -->
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header"><i class="fa fa-laptop"></i> Dashboard</h3>
                    <ol class="breadcrumb">
                        <li><i class="fa fa-home"></i><a href="/index.html">Home</a></li>
                        <li><i class="fa fa-laptop"></i>Dashboard</li>
                    </ol>
                </div>
            </div>
            <!-- end of Breadcrumb -->

            <!-- Dashboard/Statistics -->
            <div class="row row-eq-height">
                <div class="col-md-9" id="powerConsumption">
                    <div class="panel panel-primary">
                        <div class="panel-footer">Power Consumption</div>
                        <div class="panel-body">
                            <div id="chartPowerConsumption" class="chart">
                                <canvas id="areaChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3" id="currentCharges">
                    <div class="panel panel-primary">
                        <div class="panel-footer">Current Charges</div>
                        <div class="panel-body">
                            <div class="box-header">
                                <h1>RM 1,055.88</h1>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-md-3" id="box2">
                    <div class="panel panel-primary">
                        <div class="panel-footer">Box 2</div>
                        <div class="panel-body">
                            <div class="box-header">
                                <h1>abc</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end of Dashboard/Statistics -->

            <!-- Start of Map -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-primary">
                        <div class="panel-footer">Map View</div>
                        <div class="col-md-3 col-sm-4">
                            <h3>Filter By</h3>
                            <div class="pad box-pane-left bg-green" style="min-height: 180px">
                                <div class="filter-block margin-bottom">
                                    <h5 class="filter-header">Location</h5>
                                    <form id="filter-location-form" class=form-horizontal">
                                        <div class="form-group" style="display:inline;">
                                            <!--<label for="filter-1" class="col-sm-3 control-label"></label>-->
                                            <div class="input-group">
                                                <!--inner-addon.left-addon <i class="glyphicon glyphicon-search"></i>-->
                                                <input id="filter-dt-address" type="text" class="form-control"
                                                       placeholder="">
                                                <span class="input-group-addon"><span
                                                        class="glyphicon glyphicon-search"></span> </span>
                                            </div>
                                        </div>
                                    </form>
                                </div><!-- /.filter-block -->
                                <div class="filter-block margin-bottom" style="display: none;">
                                    <h5 class="filter-header">Referrals</h5>
                                    <form id="filter-referrals-form" class=form-horizontal">
                                        <div class="form-group" style="display:inline;">
                                            <!--<label for="filter-2" class="col-sm-3 control-label"></label>-->
                                            <div class="input-group">
                                                <div class="input-group-btn">
                                                    <button type="button" class="btn btn-default dropdown-toggle"
                                                            data-toggle="dropdown"><span
                                                            class="glyphicon glyphicon-chevron-down"></span></button>
                                                    <ul id="filter-by-box" class="dropdown-menu">
                                                        <li><a id="node-id-dt" data-cols='0'>Node ID</a></li>
                                                        <li><a id="message-dt" data-cols='1'>Message</a></li>
                                                        <li><a id="status-dt" data-cols='2'>Status</a></li>
                                                    </ul>
                                                </div>
                                                <input id="filter-referrals" type="text" class="form-control" placeholder="">
                                                <span class="input-group-addon"><span
                                                        class="glyphicon glyphicon-search"></span> </span>
                                            </div>
                                        </div>
                                    </form>
                                </div><!-- /.filter-block -->
                                <div class="filter-block" style="display: none;">
                                    <h5 class="filter-header">Lighted</h5>
                                    <span class="filter-text">on</span>
                                </div><!-- /.filter-block -->
                            </div>
                        </div>
                        <div id="map" class="panel-body-map"></div>
                        <div class="panel-body">
                            <table id="street-light-list" class="display"
                                   cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th class="text text-center">Node ID</th>
                                    <th>Message</th>
                                    <th>Status</th>
                                    <th>Group</th>
                                    <th></th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Map -->
        </section>
    </section>
    <!-- End of main content -->
</section>
<script>
    var map, marker, markerLight = [];
    var table;
    function initMap() {
        var lat = 2.930327, lng = 101.658908, zoomLevel = 18;
        var mapOptions = {
            // How zoomed in you want the map to start at (always required)
            zoom: zoomLevel,
            styles: [{
                "featureType": "landscape",
                "stylers": [{"hue": "#FFBB00"}, {"saturation": 43.400000000000006}, {"lightness": 37.599999999999994}, {"gamma": 1}]
            }, {
                "featureType": "road.highway",
                "stylers": [{"hue": "#FFC200"}, {"saturation": -61.8}, {"lightness": 45.599999999999994}, {"gamma": 1}]
            }, {
                "featureType": "road.arterial",
                "stylers": [{"hue": "#FF0300"}, {"saturation": -100}, {"lightness": 51.19999999999999}, {"gamma": 1}]
            }, {
                "featureType": "road.local",
                "stylers": [{"hue": "#FF0300"}, {"saturation": -100}, {"lightness": 52}, {"gamma": 1}]
            }, {
                "featureType": "water",
                "stylers": [{"hue": "#0078FF"}, {"saturation": -13.200000000000003}, {"lightness": 2.4000000000000057}, {"gamma": 1}]
            }, {
                "featureType": "poi",
                "stylers": [{"hue": "#00FF6A"}, {"saturation": -1.0989010989011234}, {"lightness": 11.200000000000017}, {"gamma": 1}]
            }]
        };
        map = new GMaps({
            div: '#map',
            lat: lat,
            lng: lng,
            options: mapOptions,
            width: 'auto',
            height: '350px',
            idle: function () {
                map.refresh();
                //map.setCenter(currLat, currLng);
            },
            resize: function (e) {
                var center = map.getCenter();
                map.setCenter(center.lat(), center.lng());
            }
        });
    }

    function requestData() {
        $.ajax({
            url: 'live-server-data.php',
            success: function (point) {
                var series = chart.series[0],
                        shift = series.data.length > 20; // shift if the series is
                                                         // longer than 20

                // add the point
                chart.series[0].addPoint(point, true, shift);

                // call it again after one second
                setTimeout(requestData, 1000);
            },
            cache: false
        });
    }

    function getBatteryPower(level) {
        if (level == 100) {
            return "Full Power";
        } else if (level == 1) {
            return "Hibernating";
        } else if (level > 30) {
            return level+"% Remaining";
        } else if (level <= 30) {
            return "Low Battery";
        } else return "No Response";
    }

    function getLightStatus(state) {
        if (state == 1) return "ON";
        else if (state == 0) return "OFF";
        else return "Error";
    }

    function callbackRowCreated (row, data, dataIndex) {
        $(row).addClass('text text-center');
        var nodeId = data.id,
                message = getBatteryPower(data.battery_level),
                status = getLightStatus(data.state),
                group = data.type,
                latLng = data.location;

        // Replace the data
        $(row).find('td:eq(0)').html(nodeId);
        $(row).find('td:eq(1)').html(message);
        $(row).find('td:eq(2)').html(status);
        $(row).find('td:eq(3)').html(group);
        $(row).find('td:eq(4)').html(latLng);

        // Attach some data attributes to the <TR>
        $(row).attr('data-row-id', nodeId);

        loadMarkerMap(data);
    }

    // On Load
    $(function () {
        // Dummy set the value
        $("#chartPowerConsumption").highcharts({
            title: {
                text: null
            },
            chart: {
                type: 'areaspline',
                zoomType: 'x',
                animation: Highcharts.svg, // don't animate in old IE
                marginRight: 10,
                events: {
                    load: function () {

                        // set up the updating of the chart each second
                        var series = this.series[0];
                        setInterval(function () {
                            var x = (new Date()).getTime(), // current time
                                    y = Math.random();
                            series.addPoint([x, y], true, true);
                        }, 1000);
                    }
                }
            },
            xAxis: {
                type: 'datetime',
                tickInterval: 3600 * 1000
            },
            series: [{
                data: (function () {
                    // generate an array of random data
                    var data = [], time = (new Date()).getTime(), i;

                    for (i = -19; i <= 0; i += 1) {
                        data.push({
                            x: time + i * 1000,
                            y: Math.random()
                        });
                    }
                    return data;
                }())
            }],
            tooltip: {
                formatter: function () {
                    return '<b>' + this.series.name + '</b><br/>' +
                            Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                            Highcharts.numberFormat(this.y, 2);
                }
            }
        });
        Highcharts.setOptions(Highcharts.themes['pastel']);

        table = $('#street-light-list').DataTable({
            "ajax": {
                "url": "api.json",//http://2b6c3c50-0156-4c5b-86b5-15db1e60e17f.iot.tmrnd.com.my:8090/assets",
                "dataSrc": "Data"
            },
            "columns" : [
                {"data" : "id", "className" : "text-left", "width": "10%"},                                          // node id
                {"data" : "battery_level", "className" : "text-left", "width": "6%"},                                // message
                {"data" : "state", "className" : "text-left", "width": "6%"},                                        // status
                {"data" : "type", "className" : "text-left", "width": "10%"},                                        // group
                {"data" : "location", "visible": false, "searchable" : false}                                        // latLng
            ],
            "rowId" : "id",
            "createdRow" : callbackRowCreated,
            select: {
                style: 'single'
            },
            bLengthChange: false,
            "bInfo": true,
            "bFilter": false
        });

        $('#street-light-list tbody').on('click', 'tr', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var data = table.row($(this).closest('tr')).data();

            singleMarkerMap(data);
        });

        $('#filter-location-form').submit(function (e) {
            e.preventDefault();
            GMaps.geocode({
                address: $('#filter-dt-address').val().trim(),
                callback: function (results, status) {
                    console.log(JSON.stringify(results));
                    if (status == 'OK') {
                        var newLatLng = results[0].geometry.location;
                        map.setCenter(newLatLng.lat(), newLatLng.lng());
//                        marker.setPosition(newLatLng);
                    }
                }
            });
        });

        var filterCol = $('#filter-by-box li a').attr('data-cols');
        $('#filter-by-box li a').on('click', function(e){
            e.preventDefault();
            $('#filter-referrals').val('');
            filterCol = $(this).attr('data-cols');
        });

//        $('#filter-referrals-form').submit(function (e) {
//            e.preventDefault();
        $('input#filter-referrals').on( 'keyup click', function (e) {
            e.preventDefault();
//            var column = filterCol;
//            // change state to number
//            if (column == 2) {
//                this.value = statusNumerical(this.value);
//            }
//            //console.log(column, textToFilter);
//            //table.column(column).search(textToFilter).draw();
//            //console.log(table.columns(column).data().eq( 0 )[column]);
////            table
//
////                    .columns( column )
////                    .search( textToFilter )
////                    .draw();
//            //console.log(column, this.value);
//            if ( table.search() !== this.value ) {
//                console.log("search", "t "+table.search(), "v "+this.value);
//                table
//                        .search( this.value )
//                        .draw();
//            }
            table.draw();
        });
    });

    function statusNumerical(state) {
        switch (state.toLowerCase()) {
            case "on": return 1;
            case "off": return 0;
            default: return -1;
        }
    }

    function filterByReferrals(column, textToFilter) {
        console.log(column, textToFilter);
        if (textToFilter == "") return;
        $('#street-light-list').DataTable().search(

        ).draw();
        $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {
                    console.log(settings, data, dataIndex);
                    var rowData = data[column];
                    return !!(rowData === textToFilter || textToFilter.indexOf(rowData) > -1);
                }
        );
    }


    function singleMarkerMap(data) {
        if (map === undefined || table == null) return;

        var pinColor = "CDDC39";
        var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
                new google.maps.Size(28, 34),
                new google.maps.Point(0,0),
                new google.maps.Point(10, 34));
        var pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
                new google.maps.Size(40, 37),
                new google.maps.Point(0, 0),
                new google.maps.Point(12, 35));

        map.removeMarker(markerLight[0]);
        markerLight.length = 0;
        var latLng = new google.maps.LatLng(parseFloat(data.location.lat), parseFloat(data.location.long));
        var markerL = map.createMarker({
            position: latLng
            ,icon: pinImage
            ,shadow: pinShadow
            ,infoWindow: {
                content: '<div id="mapInfo">'+
                '<p><strong>Light Id: '+data.id+'</strong><br><br>'+
                '<i class="fa fa-lightbulb-o"></i>Light State: '+getLightStatus(data.state)+'<br>' +
                '<i class="fa fa-battery-3"></i>Battery Level: '+getBatteryPower(data.battery_level)+'<br>'+
                '</div>'
            }
        });
        markerLight.push(markerL);
        map.addMarker(markerLight[0]);
        map.setCenter(parseFloat(data.location.lat), parseFloat(data.location.long));

    }

    function loadMarkerMap(data) {
        if (map === undefined || table == null) return;

        var pinColor = "E53935";
        var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
                new google.maps.Size(20, 32),
                new google.maps.Point(0,0),
                new google.maps.Point(10, 34));
        var pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
                new google.maps.Size(40, 37),
                new google.maps.Point(0, 0),
                new google.maps.Point(12, 35));

        var latLng = new google.maps.LatLng(parseFloat(data.location.lat), parseFloat(data.location.long));
        data.marker = map.createMarker({
            position: latLng
//          ,icon: $this.data('icon')
            ,icon: pinImage
            ,shadow: pinShadow
            ,infoWindow: {
                content: '<div id="mapInfo">'+
                '<p><strong>Light Id: '+data.id+'</strong><br><br>'+
                '<i class="fa fa-lightbulb-o"></i>Light State: '+getLightStatus(data.state)+'<br>' +
                '<i class="fa fa-battery-3"></i>Battery Level: '+getBatteryPower(data.battery_level)+'<br>'+
                '</div>'
            }
        });

        map.addMarker(data.marker);
    }

    function loadZoneMarkerMap(d) {
        if (map === null || table == null) return;
        var pointers = [];
        var markerBounds = new google.maps.LatLngBounds();
        //pointers =
//        if (!d && table.rows('.selected').data()[0]) {
//            if (table.rows('.selected').data()[0][4]) {
//                pointers = table.rows('.selected').data()[0][4];
//            }
//        } else {
//            pointers = d[4];
//            map.removeMarkers();
//            pointers.forEach(function (latLng) {
//                var position = new google.maps.LatLng(latLng[0], latLng[1]);
//                map.addMarker({
//                    lat: latLng[0]
//                    , lng: latLng[1]
////                    ,icon: $this.data('icon')
//                });
//                markerBounds.extend(position);
//            });
//            map.fitBounds(markerBounds);
//        }
    }

</script>
<!-- Google Map -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWUMinfvGZQYP3Ow_h71CnCqYaEOrvJj0&callback=initMap"
        async defer></script>
</body>
</html>